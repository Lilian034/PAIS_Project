services:
  # ==================== 民眾問答系統 ====================
  public_api:
    build: ./rag_service
    container_name: pais-public-api
    command: uvicorn public_service:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8000:8000"
    volumes:
      - ./rag_service:/app
      - ./documents:/app/documents
      - ./chat_history/public:/app/chat_history
      - ./logs:/app/logs
      - ./qdrant_storage:/app/qdrant_storage
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    depends_on:
      - qdrant
    restart: unless-stopped

  # ==================== 幕僚系統 ====================
  staff_api:
    build: ./rag_service
    container_name: pais-staff-api
    command: uvicorn staff_service:app --host 0.0.0.0 --port 8001 --reload
    ports:
      - "8001:8001"
    volumes:
      - ./rag_service:/app
      - ./documents:/app/documents
      - ./chat_history/staff:/app/chat_history
      - ./generated_content:/app/generated_content
      - ./database:/app/database
      - ./logs:/app/logs
      - ./qdrant_storage:/app/qdrant_storage
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - STAFF_PASSWORD=${STAFF_PASSWORD}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - MAYOR_VOICE_ID=${MAYOR_VOICE_ID}
      - RUNWAY_API_KEY=${RUNWAY_API_KEY}
    depends_on:
      - qdrant
    restart: unless-stopped

  # ==================== 向量資料庫 ====================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: pais-qdrant
    ports:
      - "6333:6333"
    volumes:
      - ./qdrant_storage:/qdrant/storage
    restart: unless-stopped

  # ==================== Nginx 反向代理 ====================
  nginx:
    image: nginx:alpine
    container_name: pais-nginx
    ports:
      - "80:80"
    volumes:
      - ./frontend:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - public_api
      - staff_api
    restart: unless-stopped